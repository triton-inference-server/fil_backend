From c9c2aee16966887f1e746b43c9e78deca4a17704 Mon Sep 17 00:00:00 2001
From: Hyunsu Cho <phcho@nvidia.com>
Date: Tue, 12 Aug 2025 12:05:04 -0700
Subject: [PATCH] Patch FindOpenMP

---
 cmake/rapids_config.cmake                   |  2 +-
 cpp/CMakeLists.txt                          |  2 +-
 cpp/cmake/thirdparty/get_raft.cmake         |  1 +
 cpp/cmake/thirdparty/get_treelite.cmake     |  1 +
 cpp/cmake/thirdparty/patches/raft.patch     | 36 +++++++++++++++++++++
 cpp/cmake/thirdparty/patches/treelite.patch | 25 ++++++++++++++
 6 files changed, 65 insertions(+), 2 deletions(-)
 create mode 100644 cpp/cmake/thirdparty/patches/raft.patch
 create mode 100644 cpp/cmake/thirdparty/patches/treelite.patch

diff --git a/cmake/rapids_config.cmake b/cmake/rapids_config.cmake
index 5aa8e5501..7f85bcc05 100644
--- a/cmake/rapids_config.cmake
+++ b/cmake/rapids_config.cmake
@@ -25,5 +25,5 @@ else()
       "Could not determine RAPIDS version. Contents of VERSION file:\n${_rapids_version_formatted}")
 endif()

-set(rapids-cmake-version "${RAPIDS_VERSION_MAJOR_MINOR}")
+set(rapids-cmake-version "25.10")
 include("${CMAKE_CURRENT_LIST_DIR}/RAPIDS.cmake")
diff --git a/cpp/CMakeLists.txt b/cpp/CMakeLists.txt
index 918416085..d9b64feed 100644
--- a/cpp/CMakeLists.txt
+++ b/cpp/CMakeLists.txt
@@ -163,7 +163,7 @@ if(CUDA_STATIC_MATH_LIBRARIES)
 endif()

 if (NOT DISABLE_OPENMP)
-  find_package(OpenMP)
+  find_package(OpenMP REQUIRED CXX)
   if(OpenMP_FOUND)
     message(STATUS "CUML_CPP: OpenMP found in ${OPENMP_INCLUDE_DIRS}")
     list(APPEND CUML_CXX_FLAGS ${OpenMP_CXX_FLAGS})
diff --git a/cpp/cmake/thirdparty/get_raft.cmake b/cpp/cmake/thirdparty/get_raft.cmake
index 7659384cc..bc9d785b3 100644
--- a/cpp/cmake/thirdparty/get_raft.cmake
+++ b/cpp/cmake/thirdparty/get_raft.cmake
@@ -51,6 +51,7 @@ function(find_and_configure_raft)
         GIT_REPOSITORY         https://github.com/${PKG_FORK}/raft.git
         GIT_TAG                ${PKG_PINNED_TAG}
         SOURCE_SUBDIR          cpp
+        PATCHES                "./patches/raft.patch"
         EXCLUDE_FROM_ALL       ${PKG_EXCLUDE_FROM_ALL}
         OPTIONS
           "BUILD_TESTS OFF"
diff --git a/cpp/cmake/thirdparty/get_treelite.cmake b/cpp/cmake/thirdparty/get_treelite.cmake
index 11c4f5a26..4cdb8cc04 100644
--- a/cpp/cmake/thirdparty/get_treelite.cmake
+++ b/cpp/cmake/thirdparty/get_treelite.cmake
@@ -34,6 +34,7 @@ function(find_and_configure_treelite)
         CPM_ARGS
             GIT_REPOSITORY   https://github.com/dmlc/treelite.git
             GIT_TAG          ${PKG_PINNED_TAG}
+            PATCHES          "./patches/treelite.patch"
             EXCLUDE_FROM_ALL ${PKG_EXCLUDE_FROM_ALL}
             OPTIONS
               "USE_OPENMP ON"
diff --git a/cpp/cmake/thirdparty/patches/raft.patch b/cpp/cmake/thirdparty/patches/raft.patch
new file mode 100644
index 000000000..e95c99d5d
--- /dev/null
+++ b/cpp/cmake/thirdparty/patches/raft.patch
@@ -0,0 +1,36 @@
+From 293641fa4dfd8deaf9b49fa3ec4b6874ce8ec438 Mon Sep 17 00:00:00 2001
+From: Hyunsu Cho <phcho@nvidia.com>
+Date: Tue, 12 Aug 2025 12:04:09 -0700
+Subject: [PATCH] Patch FindOpenMP
+
+---
+ cmake/rapids_config.cmake | 2 +-
+ cpp/CMakeLists.txt        | 1 +
+ 2 files changed, 2 insertions(+), 1 deletion(-)
+
+diff --git a/cmake/rapids_config.cmake b/cmake/rapids_config.cmake
+index abe468dc..b0455ddc 100644
+--- a/cmake/rapids_config.cmake
++++ b/cmake/rapids_config.cmake
+@@ -26,5 +26,5 @@ else()
+   )
+ endif()
+
+-set(rapids-cmake-version "${RAPIDS_VERSION_MAJOR_MINOR}")
++set(rapids-cmake-version "25.10")
+ include("${CMAKE_CURRENT_LIST_DIR}/RAPIDS.cmake")
+diff --git a/cpp/CMakeLists.txt b/cpp/CMakeLists.txt
+index 54bdef13..05d4e52b 100644
+--- a/cpp/CMakeLists.txt
++++ b/cpp/CMakeLists.txt
+@@ -150,6 +150,7 @@ rapids_find_package(
+ if(NOT DISABLE_OPENMP)
+   rapids_find_package(
+     OpenMP REQUIRED
++    CXX
+     BUILD_EXPORT_SET raft-exports
+     INSTALL_EXPORT_SET raft-exports
+   )
+--
+2.43.0
+
diff --git a/cpp/cmake/thirdparty/patches/treelite.patch b/cpp/cmake/thirdparty/patches/treelite.patch
new file mode 100644
index 000000000..ef4600d5d
--- /dev/null
+++ b/cpp/cmake/thirdparty/patches/treelite.patch
@@ -0,0 +1,25 @@
+From 8fd0c4a601e10004ab76f4fb27fb73c411d84434 Mon Sep 17 00:00:00 2001
+From: Hyunsu Cho <phcho@nvidia.com>
+Date: Mon, 11 Aug 2025 15:38:13 -0700
+Subject: [PATCH] Patch FindOpenMP
+
+---
+ src/CMakeLists.txt | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
+index 002f1ee..c1bc170 100644
+--- a/src/CMakeLists.txt
++++ b/src/CMakeLists.txt
+@@ -22,7 +22,7 @@ if(USE_OPENMP)
+       find_package(OpenMP REQUIRED)
+     endif()
+   else()
+-    find_package(OpenMP REQUIRED)
++    find_package(OpenMP REQUIRED CXX)
+   endif()
+ else()
+   message(STATUS "Disabling OpenMP")
+--
+2.43.0
+
--
2.43.0

